---
title: OAuth2 Clients
draft:
---

---

### **üîπ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞**
–ö–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
```typescript
{
  client_id: string,          // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (UUID –∏–ª–∏ —Å–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–æ–∫–∞)
  client_secret?: string,     // –°–µ–∫—Ä–µ—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)
  redirect_uris: string[],    // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ redirect_uri
  grants: GrantType[],        // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ grant_types: ["authorization_code", "client_credentials", ...]
  scopes: string[],           // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–∞: ["read", "write", "profile"]
  client_name: string,        // –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  client_type: "public" | "confidential", // –¢–∏–ø –∫–ª–∏–µ–Ω—Ç–∞
  created_at: Date,           // –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
  updated_at: Date,           // –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  active: boolean,            // –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –∫–ª–∏–µ–Ω—Ç
  pkce_required?: boolean     // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PKCE
}
```

---

### **üîπ –°–ø–æ—Å–æ–±—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è**
#### **1. –†–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –ë–î (PostgreSQL, MySQL)**
**–ü—Ä–∏–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã:**
```sql
CREATE TABLE oauth_clients (
  client_id VARCHAR(128) PRIMARY KEY,
  client_secret VARCHAR(256) NULL,
  redirect_uris JSON NOT NULL,
  grants JSON NOT NULL,
  scopes JSON NOT NULL,
  client_name VARCHAR(255) NOT NULL,
  client_type VARCHAR(32) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  active BOOLEAN DEFAULT TRUE,
  pkce_required BOOLEAN DEFAULT FALSE
);
```

**–ü–ª—é—Å—ã:**
- –°—Ç—Ä–æ–≥–∞—è —Å—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö.
- JOIN-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
- ACID-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

#### **2. –î–æ–∫—É–º–µ–Ω—Ç–æ–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ë–î (MongoDB)**
**–ü—Ä–∏–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞:**
```javascript
{
  _id: "abc123",
  client_secret: "$2b$10$...", // –•—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ–∫—Ä–µ—Ç
  redirect_uris: ["https://app.com/callback"],
  grants: ["authorization_code"],
  scopes: ["profile"],
  client_type: "confidential",
  pkce_required: true
}
```

**–ü–ª—é—Å—ã:**
- –ì–∏–±–∫–æ—Å—Ç—å —Å—Ö–µ–º—ã.
- –õ–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è.

#### **3. In-Memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (Redis)**
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤:
```bash
HSET oauth_client:abc123 client_secret "$2b$10$..." redirect_uris "https://app.com/callback"
```

**–ü–ª—é—Å—ã:**
- –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

---

### **üîπ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
1. **–•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ client_secret**  
   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `bcrypt` –∏–ª–∏ `argon2` –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤:
   ```typescript
   import * as bcrypt from 'bcrypt';
   
   // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞:
   const hashedSecret = await bcrypt.hash(rawSecret, 10);
   ```

2. **PKCE –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤**  
   –¢—Ä–µ–±—É–π—Ç–µ `code_challenge` –∏ `code_verifier`, –µ—Å–ª–∏ `client_type === "public"`.

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è redirect_uri**  
   –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ URI:
   ```typescript
   const isValidRedirectUri = client.redirect_uris.includes(redirectUri);
   if (!isValidRedirectUri) throw new Error("Invalid redirect_uri");
   ```

---

### **üîπ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤**
#### **1. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (RFC 7591)**
–†–µ–∞–ª–∏–∑—É–π—Ç–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç `/client/register`:
```typescript
@Post('client/register')
async registerClient(@Body() dto: RegisterClientDto) {
  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è client_id –∏ client_secret
  const clientId = crypto.randomUUID();
  const clientSecret = crypto.randomBytes(32).toString('hex');
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
  return this.clientService.createClient({
    ...dto,
    client_id: clientId,
    client_secret: await bcrypt.hash(clientSecret, 10)
  });
}
```

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (RFC 7591):**
```json
{
  "client_name": "My App",
  "redirect_uris": ["https://app.com/callback"],
  "grant_types": ["authorization_code", "refresh_token"],
  "scope": "profile email"
}
```

#### **2. –†—É—á–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É**
–°–æ–∑–¥–∞–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é:
- –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ `client_id`/`client_secret`.
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∫–ª–∏–µ–Ω—Ç–æ–≤.
- –ü—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

---

### **üîπ –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞**
```typescript
// client.service.ts
async validateClient(
  clientId: string,
  clientSecret?: string,
): Promise<Client> {
  const client = await this.clientRepo.findOne({ client_id: clientId });
  
  if (!client || !client.active) {
    throw new Error("Client not found");
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–∞ –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
  if (client.client_type === "confidential") {
    const isSecretValid = await bcrypt.compare(clientSecret, client.client_secret);
    if (!isSecretValid) throw new Error("Invalid client secret");
  }

  return client;
}
```

---

### **üîπ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**
- **–û—Ç–¥–µ–ª—å–Ω–∞—è –ë–î –¥–ª—è OAuth2**: –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Ç–æ–π –∂–µ —Ç–∞–±–ª–∏—Ü–µ, —á—Ç–æ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
- **–ò–Ω–¥–µ–∫—Å—ã**: –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–¥–µ–∫—Å –Ω–∞ `client_id` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞.
- **–†–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤**: –†–µ–∞–ª–∏–∑—É–π—Ç–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å–º–µ–Ω—ã `client_secret`.
- **–ê—É–¥–∏—Ç**: –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ (`/oauth/token`, `/oauth/authorize`).


---

### **–ò—Ç–æ–≥**
- –î–ª—è **—Å—Ç–∞—Ä—Ç–∞–ø–∞/–Ω–µ–±–æ–ª—å—à–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞**: PostgreSQL + —Ä—É—á–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É.
- –î–ª—è **enterprise**: MongoDB + –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è + PKCE.
- –í—Å–µ–≥–¥–∞ **—Ö—ç—à–∏—Ä—É–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã** –∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ `redirect_uri`.

